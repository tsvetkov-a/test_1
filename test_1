create or replace PACKAGE BODY ACC IS

/******************************************************************************/

  PROCEDURE clear_atr IS
  BEGIN
    db_done_account_date := NULL;
    db_done_acc_no := NULL;
    db_done_acc_date := NULL;
    db_err_account_date := NULL;
    db_err_acc_no := NULL;
    db_err_acc_date := NULL;
  END;

/******************************************************************************/

  PROCEDURE get_done_atr(d_no VARCHAR2, skip_id NUMBER) IS
    CURSOR c_done_atr(d_no VARCHAR2, skip_id NUMBER) IS
      SELECT s.account_date, s.acc_no, s.acc_date
      FROM ppo_voldates w, ppo_voldates s
      WHERE w.id = s.voldate_id
        AND w.ord_id = (SELECT w1.ord_id FROM ppo_voldates w1, ppo_voldates s1 WHERE w1.id = s1.voldate_id AND s1.id = skip_id )
        AND s.done_no = d_no
        AND s.id != skip_id
      GROUP BY s.account_date, s.acc_no, s.acc_date
      ORDER BY s.acc_no, s.acc_date, s.account_date;
  BEGIN
    clear_atr;
    OPEN c_done_atr(d_no, skip_id);
    FETCH c_done_atr INTO db_done_account_date, db_done_acc_no, db_done_acc_date;
    FETCH c_done_atr INTO db_err_account_date, db_err_acc_no, db_err_acc_date;
    done_attr_count := c_done_atr%ROWCOUNT;
    CLOSE c_done_atr;
/*
DBMS_OUTPUT.put_line('no - '||db_done_acc_no||'.');
DBMS_OUTPUT.put_line('err - '||db_err_acc_no||'.');
DBMS_OUTPUT.put_line('cn - '||done_attr_count||'.');
*/
  EXCEPTION
    WHEN OTHERS THEN
      IF c_done_atr%ISOPEN THEN
        CLOSE c_done_atr;
      END IF;
  END;

/******************************************************************************/

END;
