create or replace function get_wh(r_date date) return number is
  cursor c_date(r_date date) is select wh from ref_wh where c_date = r_date;
  res number(4,2);
  dy varchar2(2);
  r_year date := trunc(r_date, 'YYYY');
begin
  open c_date(r_date);
  fetch c_date into res;
  close c_date;
  
  if res is null then
    dy := to_char(r_date, 'dy', 'nls_date_language=RUSSIAN');
    case r_year
      when to_date('01012012','ddmmyyyy') then
        if dy not in ('пт','сб','вс') then res := 8.2;
        elsif dy = 'пт' then res := 7.5;
        else res := 0;
        end if;
      when to_date('01012013','ddmmyyyy') then
        if r_date between to_date('01062013','ddmmyyyy') and to_date('31082013','ddmmyyyy') then
          -- лето 2013
          if dy not in ('пт','сб','вс') then res := 8.4;
          elsif dy = 'пт' then res := 6.4;
          else res := 0;
          end if;
        else
          if dy not in ('пт','сб','вс') then res := 8.2;
          elsif dy = 'пт' then res := 7.2;
          else res := 0;
          end if;
        end if;
      when to_date('01012014','ddmmyyyy') then
        if r_date between to_date('01062014','ddmmyyyy') and to_date('31082014','ddmmyyyy') then
          -- лето 2014
          if dy not in ('пт','сб','вс') then res := 8.4;
          elsif dy = 'пт' then res := 6.4;
          else res := 0;
          end if;
        else
          if dy not in ('пт','сб','вс') then res := 8.2;
          elsif dy = 'пт' then res := 7.2;
          else res := 0;
          end if;
        end if;
      else
        if to_number(to_char(r_date,'mm')) between 6 and 8 then
          -- лето
          if dy not in ('пт','сб','вс') then res := 8.4;
          elsif dy = 'пт' then res := 6.4;
          else res := 0;
          end if;
        else
          if dy not in ('пт','сб','вс') then res := 8.2;
          elsif dy = 'пт' then res := 7.2;
          else res := 0;
          end if;
        end if;
    end case;
  end if;

  return res;
end get_wh;
