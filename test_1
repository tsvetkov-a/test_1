--Вызов: forms, триггер pord_auto_oper_o4
PROCEDURE add_O4_prd (vd_in pls_integer) IS
vtype varchar2(4);
vid pls_integer;
oid pls_integer;
is_kp pls_integer;
sdate date;
edate date;
aper date;
mes varchar2(50);
vvol number;
dd DATE;
BEGIN
    vd := vd_in;
    SELECT voldate_type into vtype from ppo_voldates where id = vd_in;
    IF vtype = 'STG' then
        SELECT s.voldate_id, w.ord_id
            into vid, oid
            from ppo_voldates s, ppo_voldates w where s.id = vd_in and w.id = s.voldate_id;
    ELSE
        SELECT ord_id
            into oid
            from ppo_voldates where id = vd_in;
        vid := vd_in;
    END if;
    SELECT duty_date INTO dd FROM ppo_orders WHERE id = OID;
    select count(id) into is_kp from ppo_voldates where kind in ('кп') and executor = 201085 and ord_id = oid;
    if is_kp > 0 then
        auto_prd_rec('КПП',1164053,201508,null,null,null,addworkdays(dd,3));
        auto_prd_rec('КПК',1170055,201508,null,null,null,addworkdays(dd,4));
        auto_prd_rec('КПК',1170056,201508,null,null,null,addworkdays(dd,5));
        auto_prd_rec('КПК',1170057,203407,null,null,null,addworkdays(dd,6),null,null,null,null,null,201729);
        auto_prd_rec('КПК',1170058,205361,null,null,null,addworkdays(dd,7),null,null,null,null,null,205361);
    end if;
END;


PROCEDURE add_o6_is_prd (vd_in pls_integer) IS
vtype varchar2(4);
vid pls_integer;
oid pls_integer;
is_323 pls_integer;
sdate date;
edate date;
aper date;
mes varchar2(50);
vvol number;
cadd_id_is pls_integer;
rc_id_is pls_integer;
BEGIN
    vd := vd_in;
    SELECT voldate_type into vtype from ppo_voldates where id = vd_in;
    if vtype = 'STG' then
        SELECT s.voldate_id, w.ord_id, s.volume, s.s_date, s.e_date, s.accel_per, s.measure
            INTO vid, oid, vvol, sdate, edate, aper, mes
            FROM ppo_voldates s, ppo_voldates w where s.id = vd_in and w.id = s.voldate_id;
    ELSE
        RETURN;
    END if;
    SELECT count(id) into is_323 from ppo_voldates where kind in ('323') and executor = 200347 and ord_id = oid;
    if is_323 > 0 then
        for rec1 in (select cadd_id,rc_id from ppo_productions where voldate_id = vd_in and stage = 'П' and ro_id = 203169) LOOP
            cadd_id_is := rec1.cadd_id;
            rc_id_is := rec1.rc_id;
            exit;
        end loop;
        auto_prd_rec ('К', 266779, 200522, 'точка', null, null, null, null, null, null, rc_id_is, cadd_id_is);
        auto_prd_rec ('К', 203260, 200571, 'пм', null, null, null, null, null, null, rc_id_is, cadd_id_is);
        auto_prd_rec ('КК', 203262, 200571, 'пм', null, null, null, null, null, null, rc_id_is, cadd_id_is);
        auto_prd_rec ('К', 266981, 200571, 'пм', null, null, null, null, null, null, rc_id_is, cadd_id_is);
        auto_prd_rec ('ВВ', 203264, 200571, 'пм', null, null, null, null, null, null, rc_id_is, cadd_id_is);
        auto_prd_rec ('ВВ', 549165, 200571, 'пм', null, null, null, null, null, null, rc_id_is, cadd_id_is);
        auto_prd_rec ('ВВ', 272680, 200518, 'пм', null, null, null, null, null, null, rc_id_is, cadd_id_is);
    end if;
END;


PROCEDURE add_o6_ks_prd (vd_in pls_integer) IS
vtype varchar2(4);
vid pls_integer;
oid pls_integer;
is_313 pls_integer;
sdate date;
edate date;
aper date;
mes varchar2(50);
vvol number;
BEGIN
    vd := vd_in;
    SELECT voldate_type into vtype from ppo_voldates where id = vd_in;
    IF vtype = 'STG' then
        SELECT s.voldate_id, w.ord_id, s.volume, s.s_date, s.e_date, s.accel_per, s.measure
            into vid, oid, vvol, sdate, edate, aper, mes
            from ppo_voldates s, ppo_voldates w where s.id = vd_in and w.id = s.voldate_id;
    ELSE
        SELECT ord_id, volume, s_date, e_date, accel_per, measure
            into oid, vvol, sdate, edate, aper, mes
            from ppo_voldates where id = vd_in;
        vid := vd_in;
    END if;
    select count(id) into is_313 from ppo_voldates where kind in ('313') and executor = 200347 and ord_id = oid;
    if is_313 > 0 then
        auto_prd_rec('П',203169,201464,null,null,sdate,null,null,0,2);
        auto_prd_rec('К',203256,200522,null,null,sdate,null,null,6,7);
        auto_prd_rec('К',203271,200522,null,null,sdate,null,null,8,11);
        auto_prd_rec('К',268373,200522,null,null,sdate,null,null,8,9);
        auto_prd_rec('К',549108,200522,null,null,sdate,null,null,1,2);
    end if;
END;


PROCEDURE add_okr_prd_list (ord_in varchar2, prd_type pls_integer, usr VARCHAR2) IS
n548 NUMBER;
n549 NUMBER;
n550 NUMBER;
n551 NUMBER;
n552 NUMBER;
n553 NUMBER;
n554 NUMBER;
n555 NUMBER;
n556 NUMBER;
usr_id NUMBER;
BEGIN
    FOR rec IN (SELECT w.id, w.ord_id FROM ppo_voldates w, table(str2table(ord_in,',')) t WHERE w.kind = '1127' AND w.executor = 548281 AND w.ord_id = t.column_value) LOOP
      vd := rec.id;

    if prd_type = 110 then   --Создать досъем
        select max(case when name_id=551 then id end),
               max(case when name_id=552 then id end),
               max(case when name_id=554 then id end),
               max(case when name_id=555 then id end),
               max(case when name_id=556 then id end) into n551, n552, n554, n555, n556
        from ref_operations where name_id in (551,552,554,555,556) and rd_id=548281;
        select id into usr_id from ref_employees where admin_name=usr and e_date is null and EMP_TYPE='Т';
        auto_prd_rec ('ДПС', n551, 26487233, null, null, trunc(sysdate));
        auto_prd_rec ('ДПС', n552, 26498242, null, null, trunc(sysdate));
        auto_prd_rec ('ДПС', n554, 26498198, null, null, trunc(sysdate));
        auto_prd_rec ('ДПС', n555, usr_id, null, null, trunc(sysdate));
        auto_prd_rec ('ДПС', n556, 22890979, null, null, trunc(sysdate));
    elsif prd_type = 111 then --Досъем: в поле
        select max(case when name_id=548 then id end),
               max(case when name_id=549 then id end),
               max(case when name_id=550 then id end) into n548, n549, n550
        from ref_operations where name_id in (548,549,550) and rd_id=548281;
        auto_prd_rec ('ДПС', n548, 9447347, null, null, trunc(sysdate));
        auto_prd_rec ('ДПС', n549, 6589353, null, null, trunc(sysdate));
        auto_prd_rec ('ДПС', n550, 9447347, null, null, trunc(sysdate));
    else                    --112 Досъем: полевой контроль
        select id into n553 from ref_operations where name_id=553 and rd_id=548281;
        auto_prd_rec ('ДПС', n553, 25628827, null, null, trunc(sysdate));
    end if;
   END LOOP;
END;
