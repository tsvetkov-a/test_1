PROCEDURE calc_real_stg (OID PLS_INTEGER) IS
    CURSOR cur1 IS SELECT id, kind, category, executor, s_date, e_date, accel_per, volume from ppo_voldates where ord_id = oid and
		kind not in ('100','пво','141','422','426','427','428','429','809') ORDER BY kind,volume;
    CURSOR cur2(wid PLS_INTEGER) IS SELECT id, no, s_date, e_date, accel_per, volume FROM ppo_voldates WHERE voldate_id = wid ORDER BY no;
    CURSOR cur1_kl IS SELECT id, kind, category, executor, s_date, e_date, volume from ppo_voldates where ord_id = oid and
		kind = 'кл' ORDER BY kind,volume;
	i PLS_INTEGER := 0;
	ii PLS_INTEGER := 0;
	vol1 NUMBER;
	vol2 NUMBER;
	dd DATE;
	sd101 DATE;
	ed101 DATE;
	sd112 DATE;
	ed112 DATE;
	sd132 DATE;
	ed132 DATE;
	sd134 DATE;
	ed134 DATE;
	aper132 DATE;
	aper134 DATE;
	aper808 DATE;
	sd808 DATE;
	ed808 DATE;
	sd143 DATE;
	ed143 DATE;
	svol112 NUMBER;
	svol101 NUMBER;
	cnt NUMBER;
	norm_112 NUMBER;
	vol_397 NUMBER := 0;
	vol_132 NUMBER := 0;
	first_no VARCHAR2(1);
BEGIN

    calc_norm_stg(OID);
   
    SELECT duty_date INTO dd FROM ppo_orders WHERE id = OID;
/* Определяем количество работ 101 и 112 в заказе. Это и соотношение их объемов определяет Ситуацию расчета */
	for rec1 in (select volume from ppo_voldates where ord_id = oid and kind = '101') loop
		i := i + 1;
		if i = 1 then
			vol1 := rec1.volume;
		elsif i > 1 then
			vol1 := 0;
		end if;
	end loop;
	for rec2 in (select volume from ppo_voldates where ord_id = oid and kind = '112') loop
		ii := ii + 1;
		if ii = 1 then
			vol2 := rec2.volume;
		elsif ii > 1 then
			vol2 := 0;
		end if;
	end loop;
	for rec3 in (select volume from ppo_voldates where ord_id = oid and kind = '397') loop
		vol_397 := vol_397 + rec3.volume;
	end loop;
/* Цикл по всем работам заказа, внутри - определяется ситуация и, в зависимости от работы, происходит коррекция */
    ed132 := NULL;
	FOR rec1 IN cur1 LOOP
    	if i = 1 and ii = 1 and vol1 = vol2 THEN   --Ситуация 1
            IF rec1.kind = '101' THEN
                ed101 := NVL(rec1.accel_per, worktime.addworkdays(dd,get_class_norm(rec1.id, dd, rec1.volume, '2')));
                UPDATE ppo_voldates set accel_per = ed101 where id = rec1.id;
            ELSIF rec1.kind = '132' THEN
                IF ed132 is null then
                    ed132 := NVL(rec1.accel_per, worktime.addworkdays(ed101,get_class_norm(rec1.id, ed101, rec1.volume + vol_397, '2')));
                ELSE 
                    ed132 := NVL(rec1.accel_per, worktime.addworkdays(ed112,norm_112));
                END IF;
                UPDATE ppo_voldates set accel_per = ed132 where id = rec1.id;
            END IF;
        ELSIF i = 1 and ii = 1 and vol1 < vol2 THEN     --Ситуация 2
            IF rec1.kind = '101' THEN
                ed101 := NVL(rec1.accel_per, worktime.addworkdays(dd,get_class_norm(rec1.id, dd, rec1.volume, '2')));
                UPDATE ppo_voldates set accel_per = ed101 where id = rec1.id;
            ELSIF rec1.kind = '132' THEN
                IF ed132 is null then
                    ed132 := NVL(rec1.accel_per, worktime.addworkdays(ed101,get_class_norm(rec1.id, ed101, rec1.volume + vol_397, '2')));
                ELSE
                    ed132 := NVL(rec1.accel_per, worktime.addworkdays(ed112,get_class_norm(rec1.id, ed112, rec1.volume, '2')));
                END IF;
                UPDATE ppo_voldates set accel_per = ed132 where id = rec1.id;
            END IF;
        ELSIF i = 1 and ii = 1 and vol1 > vol2 THEN     --Ситуация 3
            IF rec1.kind = '101' THEN
                ed101 := NVL(rec1.accel_per, worktime.addworkdays(dd,get_class_norm(rec1.id, dd, rec1.volume, '2')));
                UPDATE ppo_voldates set accel_per = ed101 where id = rec1.id;
            ELSIF rec1.kind = '132' THEN
                IF ed132 IS NULL THEN
                    ed132 := NVL(rec1.accel_per, worktime.addworkdays(ed101,get_class_norm(rec1.id, ed101, rec1.volume + vol_397, '2')));
                ELSE
                    ed132 := NVL(rec1.accel_per, worktime.addworkdays(ed101,get_class_norm(rec1.id, ed101, rec1.volume, '2')));
                END IF;
                UPDATE ppo_voldates set accel_per = ed132 where id = rec1.id;
            END IF;
        ELSIF i = 1 and ii = 2 THEN     --Ситуация 4
            IF rec1.kind = '101' THEN
                ed101 := NVL(rec1.accel_per, worktime.addworkdays(dd,get_class_norm(rec1.id, dd, rec1.volume, '2')));
                UPDATE ppo_voldates set accel_per = ed101 where id = rec1.id;
            ELSIF rec1.kind = '132' THEN
                SELECT SUM(volume) INTO svol112 FROM ppo_voldates WHERE ord_id = OID AND kind = '112';
                SELECT SUM(volume) INTO svol101 FROM ppo_voldates WHERE ord_id = OID AND kind = '101';
                IF ed132 IS NULL THEN
                    vol_132 := rec1.volume + vol_397;
                ELSE
                    vol_132 := rec1.volume;
                END IF;                
                IF svol112 < svol101 THEN
                    ed132 := NVL(rec1.accel_per, worktime.addworkdays(ed101,get_class_norm(rec1.id, ed101, vol_132, '2')));
                ELSE
                    IF ed132 is null THEN
                        ed132 := NVL(rec1.accel_per, worktime.addworkdays(ed101,get_class_norm(rec1.id, ed101, vol_132, '2')));
                    ELSE
                        ed132 := NVL(rec1.accel_per, worktime.addworkdays(ed112,get_class_norm(rec1.id, ed112, vol_132, '2')));
                    END IF;
                END IF;
                UPDATE ppo_voldates set accel_per = ed132 where id = rec1.id;
            END IF;
        ELSIF i = 0 and ii = 0 THEN     --Ситуации 5 и 7
            SELECT count(id) into cnt from ppo_voldates where ord_id = OID and kind in ('143','527');	--OR 527
            IF cnt > 0 then
                IF rec1.kind = '132' THEN
                    ed143 := worktime.addworkdays(dd,get_class_norm(rec1.id, dd, rec1.volume, '2', '2рс'));
                    IF ed132 IS NULL THEN
                        ed132 := NVL(rec1.accel_per, worktime.addworkdays(ed143,get_class_norm(rec1.id, ed143, rec1.volume + vol_397, '2', '2рс')));
                    ELSE
                        ed132 := NVL(rec1.accel_per, worktime.addworkdays(ed143,get_class_norm(rec1.id, ed143, rec1.volume, '2', '2рс')));
                    END IF; 
                    UPDATE ppo_voldates set accel_per = ed132 where id = rec1.id;
                END IF;
    		end if;
        ELSIF i = 1 AND ii = 0 THEN     --Ситуация 6
            IF rec1.kind = '101' THEN
                ed101 := NVL(rec1.accel_per, worktime.addworkdays(dd,get_class_norm(rec1.id, dd, rec1.volume, '2')));
                UPDATE ppo_voldates set accel_per = ed101 where id = rec1.id;
            ELSIF rec1.kind = '132' THEN
                IF ed132 IS NULL THEN
                    ed132 := NVL(rec1.accel_per, worktime.addworkdays(ed101,get_class_norm(rec1.id, ed101, rec1.volume + vol_397, '2')));
                ELSE
                    ed132 := NVL(rec1.accel_per, worktime.addworkdays(ed101,get_class_norm(rec1.id, ed101, rec1.volume, '2')));
                END IF;
                UPDATE ppo_voldates set accel_per = ed132 where id = rec1.id;
            END IF;
        END if;
    END LOOP;
/* после 25.02.2019 */    
    SELECT max(e_date),MAX(accel_per) INTO ed132,aper132 FROM ppo_voldates WHERE ord_id = OID AND kind = '132';
    IF ed132 IS NULL THEN
        SELECT max(e_date),MAX(accel_per) INTO ed132,aper132 FROM ppo_voldates WHERE ord_id = OID AND kind = '397';
    ELSE
        UPDATE ppo_voldates set e_date = ed132, accel_per = aper132 where ord_id = OID AND kind = '397';
    END if;
    vol_132 := vol_397;
