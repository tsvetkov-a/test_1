procedure calc_wdh(bded in out fot_buh_deductions%rowtype) is
	cursor c_wdh(emp number, dept_id number, prd_id number) is
    select sum(wd) sum_wd, nullif(sum(wh), 0) sum_wh, nullif(sum(whn)/max(whf), 0) ko from (
    select case when re.stavka in ('П','Н') and rt.ra in ('Я','Н','ОН') then 1 else 0 end wd
    , case when regexp_like(clobagg(re.stavka) over (), '[НТ]') then nvl(wh,0) else 0 end wh
    , case when regexp_like(clobagg(re.stavka) over (), 'Н') then nvl(wh,0) else 0 end whn
    , ri.work_hours whf
    from fot_re_wd rt join ref_employees re on re.id = rt.re_id join ref_depts rd on rt.rd_id = (case when rd.dept_type = 'А' or rd.id = 200335 then 202573 else rd.id end)
      join ref_intervals ri on trunc(rt.wd, 'mm') = trunc(ri.e_date,'mm')
    where emp in (re.id, re.re_id) and rd.id = dept_id and ri.id = prd_id);

	cursor c_wdh_ord(emp number, dept_id number, prd_id number) is
    select nullif(sum(case when re.stavka in ('П','Н') and rt.ra in ('Я','Н','ОН') then 1 else 0 end), 0) sum_wd
    , nullif(sum(case when re.stavka in ('Н','Т') then nvl(rt.wh,0) else 0 end), 0) sum_wh
    , nullif(sum(case when re.stavka in ('Н') then nvl(rt.wh,0) else 0 end)/max(ri.work_hours), 0) ko
    from fot_re_wd_ord rt join ref_employees re on re.id = rt.re_id join ref_depts rd on rt.rd_id = (case when rd.dept_type = 'А' or rd.id = 200335 then 202573 else rd.id end)
      join ref_intervals ri on trunc(rt.wd, 'mm') = trunc(ri.e_date,'mm')
    where emp in (re.id, re.re_id) and rd.id = dept_id and ri.id = prd_id;

	cursor c_wdh_f(emp number, dept_id number, prd_id number) is
    select sum(wd) sum_wd, nullif(sum(wh), 0) sum_wh, nullif(sum(whn)/max(whf), 0) ko from (
    select case when re.stavka in ('П','Н') and rt.ra in ('Я','Н','ОН') then 1 else 0 end wd
    , case when regexp_like(clobagg(re.stavka) over (), '[НТ]') then nvl(wh,0) else 0 end wh
    , case when regexp_like(clobagg(re.stavka) over (), 'Н') then nvl(wh,0) else 0 end whn
    , ri.work_hours_f whf
    from fot_re_wd rt join ref_employees re on re.id = rt.re_id join ref_depts rd on rt.rd_id = (case when rd.dept_type = 'А' or rd.id = 200335 then 202573 else rd.id end)
      join ref_intervals ri on rt.wd between ri.s_date and ri.e_date
    where emp in (re.id, re.re_id) and rd.id = dept_id and ri.id = prd_id);

	cursor c_wdh_ord_f(emp number, dept_id number, prd_id number) is
    select sum(case when re.stavka in ('П','Н') and rt.ra in ('Я','Н','ОН') then 1 else 0 end) sum_wd
    , nullif(sum(case when re.stavka in ('Н','Т') then nvl(wh,0) else 0 end), 0) sum_wh
    , nullif(sum(case when re.stavka in ('Н') then nvl(wh,0) else 0 end)/max(ri.work_hours_f), 0) ko
    from fot_re_wd_ord rt join ref_employees re on re.id = rt.re_id join ref_depts rd on rt.rd_id = (case when rd.dept_type = 'А' or rd.id = 200335 then 202573 else rd.id end)
      join ref_intervals ri on rt.wd between ri.s_date and ri.e_date
    where emp in (re.id, re.re_id) and rd.id = dept_id and ri.id = prd_id;

begin
  for w in c_wdh(bded.re_id, bded.rd_id, bded.ri_id) loop
    bded.workdays := w.sum_wd;
    bded.workhours := w.sum_wh;
    bded.pay_coeff := w.ko;
  end loop;
  for wf in c_wdh_f(bded.re_id, bded.rd_id, bded.ri_id) loop
    bded.workdays_f := wf.sum_wd;
    bded.workhours_f := wf.sum_wh;
    bded.pay_coeff_f := wf.ko;
  end loop;

  if bded.rd_id = 200347 then
    for w in c_wdh_ord(bded.re_id, bded.rd_id, bded.ri_id) loop
      bded.workdays := nullif(nvl(bded.workdays, 0) + nvl(w.sum_wd, 0), 0);
      bded.workhours := nullif(nvl(bded.workhours, 0) + nvl(w.sum_wh, 0), 0);
      bded.pay_coeff := nullif(nvl(bded.pay_coeff, 0) + nvl(w.ko, 0), 0);
    end loop;
    for wf in c_wdh_ord_f(bded.re_id, bded.rd_id, bded.ri_id) loop
      bded.workdays_f := nullif(nvl(bded.workdays_f, 0) + nvl(wf.sum_wd, 0), 0);
      bded.workhours_f := nullif(nvl(bded.workhours_f, 0) + nvl(wf.sum_wh, 0), 0);
      bded.pay_coeff_f := nullif(nvl(bded.pay_coeff_f, 0) + nvl(wf.ko, 0), 0);
    end loop;
  end if;
end calc_wdh;
