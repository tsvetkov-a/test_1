PROCEDURE add_3_otd_prd (vd_in pls_integer) IS
vtype varchar2(4);
vid pls_integer;
oid pls_integer;
is_wrk pls_integer;
is_wrk1 pls_integer;
is_wrk2 pls_integer;
is_wrk3 pls_integer;
is_wrk4 pls_integer;
is_wrk5 pls_integer;
is_5 pls_integer;
is_do pls_integer;
is_785 pls_integer;
is_371 pls_integer;
is_926 pls_integer;
is_kl PLS_INTEGER;
is_stg pls_integer;
vvol_153 number;
vvol number;
ovol number;
is_sec varchar2(1);
sdate date;
edate date;
aper date;
sdate_207 date;
edate_207 date;
aper_207 date;
edate_100 date;
aper_100 date;
sdate_210668 date;
edate_210668 date;
aper_210668 date;
sdate_210668w date;
edate_210668w date;
aper_210668w date;
ater varchar2(1);
reg varchar2(1);
edate_371 date;
aper_371 date;
sd_134st2 date;
ed_134st2 date;
aper_134st2 date;
sd_856st2 date;
ed_856st2 date;
aper_856st2 date;
roid pls_integer;
reid pls_integer;
s1_cnt NUMBER;
fs VARCHAR2(10);
duty_d date;
is_brd PLS_INTEGER;
is_ngu pls_integer;
ngu_vol NUMBER;
cnt_877 NUMBER;
BEGIN
    vd := vd_in;
    SELECT voldate_type into vtype from ppo_voldates where id = vd_in;
    if vtype = 'STG' then
        SELECT s.voldate_id, w.ord_id, s.volume, s.s_date, s.e_date, s.accel_per
            into vid, oid, vvol, sdate, edate, aper
            from ppo_voldates s, ppo_voldates w where s.id = vd_in and w.id = s.voldate_id;
        BEGIN
            select s.s_date,s.e_date,s.accel_per
               into sd_134st2,ed_134st2,aper_134st2
               from ppo_voldates s,ppo_voldates w
               where w.ord_id = oid and w.kind = '134' and w.id = s.voldate_id and s.no = '2';
        EXCEPTION
            when others then
               null;
        END;
        BEGIN
            SELECT s.s_date,s.e_date,s.accel_per
               into sd_856st2,ed_856st2,aper_856st2
               from ppo_voldates s,ppo_voldates w
               where w.ord_id = oid and w.kind = '856' and w.id = s.voldate_id and s.no = '2';
        EXCEPTION
            when others then
               null;
        END;
    ELSE
        SELECT ord_id, volume, s_date, e_date, accel_per
            INTO oid, vvol, sdate, edate, aper
            FROM ppo_voldates where id = vd_in;
        vid := vd_in;
    END if;
    select round(sum(square_gra)/10000,2) into ovol from centroid_ppo where numberarea = oid;
    select confident,att_terr,region,fin_source,duty_date into is_sec,ater,reg,fs,duty_d from ppo_orders where id = oid;
    select count(id) into is_5 from ppo_voldates where kind in ('105') and /*executor = 200339 and*/ ord_id = oid;
    select count(id) into is_wrk from ppo_voldates where kind in ('100','101') and /*executor = 200339 and*/ ord_id = oid;
    select count(id) into is_kl from ppo_voldates where kind in ('200','967') and /*executor = 200339 and*/ ord_id = oid;
    select count(id) into cnt_877 from ppo_voldates where kind in ('877') and /*executor = 200339 and*/ ord_id = oid;
    if is_wrk > 0 then
        begin
            select e_date, accel_per into edate_100, aper_100 from ppo_voldates where kind in ('100','101') and /*executor = 200339 and*/ ord_id = oid;
        exception
            when others then
                edate_100 := null;
                aper_100 := null;
        end;
        SELECT COUNT(id) INTO s1_cnt FROM ppo_voldates WHERE NO = '1' AND voldate_id IN (SELECT id FROM ppo_voldates WHERE ord_id = oid);
    end if;
    select count(id) into is_do from ppo_voldates where kind in ('808','207','215') and /*executor = 200339 and*/ ord_id = oid;
    if is_do > 0 then
        begin
            select e_date, accel_per into edate_207, aper_207 from ppo_voldates where kind in ('808','207','215') and /*executor = 200339 and*/ ord_id = oid;
        exception
            when others then
                edate_207 := null;
                aper_207 := null;
        end;
    end if;
    begin
        select s_date, e_date, accel_per into sdate_210668, edate_210668, aper_210668 from ppo_voldates where kind in ('132','159','421') and /*executor = 200339 and*/ ord_id = oid;
    exception
        when no_data_found then
            sdate_210668 := null;
            edate_210668 := null;
            aper_210668 := null;
        when too_many_rows then
--          for rec132 in (select s_date, e_date, accel_per from ppo_voldates where kind in ('132','159','421') and executor = 200347 and ord_id = oid order by nvl(e_date_fact,accel_per) desc) loop
            for rec132 in (select id, s_date, e_date, accel_per from ppo_voldates where kind in ('132','159','421') and /*executor = 200339 and*/ ord_id = oid order by nvl(e_date_fact,accel_per) asc) loop
                for rec132_s in (select s_date,e_date,accel_per from ppo_voldates where voldate_id = rec132.id order by no) loop
                    sdate_210668 := rec132_s.s_date;
                    edate_210668 := rec132_s.e_date;
                    aper_210668 := rec132_s.accel_per;
                    exit;
                end loop;
                sdate_210668w := rec132.s_date;
                edate_210668w := rec132.e_date;
                aper_210668w := rec132.accel_per;
            end loop;
            if sdate_210668 is null then
                sdate_210668 := sdate_210668w;
                edate_210668 := edate_210668w;
                aper_210668 := aper_210668w;
            end if;
    end;
    select count(id) into is_371 from ppo_voldates where kind in ('371') and ord_id = oid;
    if is_371 > 0 then
        for rec371 in (select e_date, accel_per from ppo_voldates where kind in ('371') and /*executor = 200339 and*/ ord_id = oid order by nvl(e_date_fact,accel_per) desc) loop
            edate_371 := rec371.e_date;
            aper_371 := rec371.accel_per;
            exit;
        end loop;
        select count(id) into is_stg from ppo_voldates where voldate_id in
            (select id from ppo_voldates where ord_id = oid);
    end if;
    if is_wrk > 0 then
        auto_prd_rec_ugp ('ПТ', 235, 200374, 'га', ovol);
        if sdate is not null and edate is not null then
            IF aper is not null then
                auto_prd_rec_ugp ('ПТ', 353, 201769, 'га', vvol,
                    sdate, addworkdays(sdate, ceil(getworkdays(edate,sdate)/2)), addworkdays(sdate, ceil((getworkdays(aper,sdate)-1)/2)));
            else
                auto_prd_rec_ugp ('ПТ', 353, 201769, 'га', vvol, sdate, addworkdays(sdate, ceil(getworkdays(edate,sdate)/2)));
            end if;
        else
            auto_prd_rec_ugp ('ПТ', 353, 201769, 'га', vvol);
        end if;
        IF sdate is not null and edate is not null then
            if aper is not null then
                auto_prd_rec_ugp ('ПТ', 274, 203500, 'га', vvol,
                    sdate, addworkdays(sdate, ceil(getworkdays(edate,sdate)/2)), addworkdays(sdate, ceil((getworkdays(aper,sdate)-1)/2)));
            else
                auto_prd_rec_ugp ('ПТ', 274, 203500, 'га', vvol, sdate, addworkdays(sdate, ceil(getworkdays(edate,sdate)/2)));
            end if;
        else
            auto_prd_rec_ugp ('ПТ', 274, 203500, 'га', vvol);
        end if;
        IF (is_wrk > 0 or is_5 > 0) and sdate is not null and edate is not null then
            if aper is not null then
                auto_prd_rec_ugp ('КТ', 198, 201773, 'га', ovol,
                    addworkdays(addworkdays(sdate,1), ceil(getworkdays(edate,sdate)/2)),addworkdays(edate, -1),addworkdays(aper, -1));
            else
                auto_prd_rec_ugp ('КТ', 198, 201773, 'га', ovol,
                    addworkdays(addworkdays(sdate,1), ceil(getworkdays(edate,sdate)/2)),addworkdays(edate, -1));
            end if;
        ELSIF   is_wrk = 0 and is_5 = 0 and sdate is not null and edate is not null then
            if aper is not null then
                auto_prd_rec_ugp ('КТ', 198, 201773, 'га', ovol, sdate, addworkdays(edate, -1), addworkdays(aper, -1));
            else
                auto_prd_rec_ugp ('КТ', 198, 201773, 'га', ovol, sdate, addworkdays(edate, -1));
            end if;
        ELSE
            auto_prd_rec_ugp ('КТ', 198, 201773, 'га', ovol);
        end if;
        --ACDOG-678
        if (is_wrk > 0 or is_5 > 0) and nvl(is_sec,'N')='N' then
            auto_prd_rec_ugp ('ОТЧ', 238, 20552633, 'отчет');
        end if;
        IF sdate is not null and edate is not null then
            if aper is not null then
                auto_prd_rec_ugp ('ККТ', 119, 201780, 'га', ovol, edate, edate, aper);
            else
                auto_prd_rec_ugp ('ККТ', 119, 201780, 'га', ovol, edate, edate);
            end if;
        else
            auto_prd_rec_ugp ('ККТ', 119, 201780, 'га', ovol);
        end if;
        IF vtype = 'STG' and (ater = 'Y' OR reg = 'Y') then
            auto_prd_rec_ugp ('КР', 178, 201850, 'га', ovol, NULL, addworkdays(edate_371,-3), addworkdays(aper_371,-3));
        else
            IF edate_210668 is not null then
                IF aper_210668 is not null then
                    auto_prd_rec_ugp ('КР', 178, 201850, 'га', ovol, edate_210668, edate_210668, aper_210668);
                else
                    auto_prd_rec_ugp ('КР', 178, 201850, 'га', ovol, edate_210668, edate_210668, aper);
                end if;
            else
                auto_prd_rec_ugp ('КР', 178, 201850, 'га', ovol);
            end if;
        end if;
        IF edate_210668 is not null then
            if nvl(ovol,0) >= 10 then
                IF aper_210668 is not null then
                    auto_prd_rec_ugp ('КП', 400, 201850, 'га', ovol, edate_210668, edate_210668, aper_210668);
                else
                    auto_prd_rec_ugp ('КП', 400, 201850, 'га', ovol, edate_210668, edate_210668, aper);
                end if;
            else
                IF aper_210668 is not null then
                    auto_prd_rec_ugp ('КП', 400, 201850, 'га', ovol, addworkdays(edate_210668,-1), addworkdays(edate_210668,-1), addworkdays(aper_210668,-1));
                else
                    auto_prd_rec_ugp ('КП', 400, 201850, 'га', ovol, addworkdays(edate_210668,-1), addworkdays(edate_210668,-1), addworkdays(aper,-1));
                end if;
            end if;
        else
            auto_prd_rec_ugp ('КП', 400, 201850, 'га', ovol);
        end if;
        IF aper_100 is not null then
            auto_prd_rec_ugp ('КП', 148, 201850, 'га', ovol, addworkdays(edate_100,2), addworkdays(edate_100,3), addworkdays(aper_100,3));
        else
            auto_prd_rec_ugp ('КП', 148, 201850, 'га', ovol, addworkdays(edate_100,2), addworkdays(edate_100,3));
        end if;
        if ater = 'Y' or reg = 'Y' then
            IF vtype = 'STG' and nvl(ovol,0) <= 25 then
                auto_prd_rec_ugp ('ККП', 301, 214622, 'га', ovol, edate_210668, addworkdays(edate_371,-6), addworkdays(aper_371,-6));
            ELSIF vtype = 'STG' and nvl(ovol,0) > 25 then
                auto_prd_rec_ugp ('ККП', 301, 214622, 'га', ovol, edate_210668, addworkdays(edate_371,-7), addworkdays(aper_371,-9));
            end if;
        end if;
        IF vtype = 'STG' and sd_134st2 is not null then
            if aper_134st2 is not null then
                auto_prd_rec_ugp ('ВВ', 210, 200374, 'га', ovol, sd_134st2, ed_134st2, aper_134st2);
            else
                auto_prd_rec_ugp ('ВВ', 210, 200374, 'га', ovol, sd_134st2, ed_134st2);
            end if;
        else
            if edate_210668 is not null then
                IF aper_207 is null and aper_210668 is not null then
                    auto_prd_rec_ugp ('ВВ', 210, 200374, 'га', ovol, addworkdays(edate_210668,1), addworkdays(edate_210668,1), aper_210668);
                ELSIF aper_207 is not null and aper_210668 is not null and abs(getworkdays(aper_207,aper_210668)) <= 1 then
                    auto_prd_rec_ugp ('ВВ', 210, 200374, 'га', ovol, addworkdays(edate_210668,1), addworkdays(edate_210668,1), aper_210668);
                ELSIF aper_207 is not null and aper_210668 is not null and abs(getworkdays(aper_207,aper_210668)) > 1 then
                    auto_prd_rec_ugp ('ВВ', 210, 200374, 'га', ovol, addworkdays(edate_210668,1), addworkdays(edate_210668,1), addworkdays(aper_210668,1));
                else
                    auto_prd_rec_ugp ('ВВ', 210, 200374, 'га', ovol, addworkdays(edate_210668,1), addworkdays(edate_210668,1));
                END if;
            ELSE
                auto_prd_rec_ugp ('ВВ', 210, 200374, 'га', ovol);
            END if;
        end if;
