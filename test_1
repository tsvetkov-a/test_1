procedure send_mail(m_name varchar2, m_params xmltype := null) as 
    m_date date := sysdate;
    sender varchar2(4000);
    rcp varchar2(4000);
    m_subj varchar2(4000);
    m_body clob;
    att xmltype;
    err clob;
/*--------------------------------------------------------------------------------------------------------------------*/
    procedure send_error(err clob) is
      t clob;
      emails varchar2(4000);
--      emails_default constant varchar2(200) := 'ekryukov@t80.mggt,artem@iitp.mggt,vtrunov@iitp.mggt';
      emails_default constant varchar2(200) := 'vtrunov@iitp.mggt';
      err_params xmltype;
    begin
      begin
--        execute immediate 'select get_mail_address.dba_emails from dual' into emails;
        emails := nvl(emails, emails_default);
      exception
        when others then emails := emails_default;
      end;
      select updatexml(m_params, '/TABLE/TR/TD/ATTACHMENT/CONTENT/text()', 'skipped') into err_params from dual;
      t := '<html><body>'||err||chr(10)||'<br/>Сообщение "'||m_name||'".';
      t := t||chr(10)||'<br/>Отправитель "'||sender||'".';
      t := t||chr(10)||'<br/>Получатель "'||rcp||'".';
      t := t||chr(10)||'<br/>Дата отправки '||to_char(m_date, 'dd.mm.yyyy hh24:mi:ss')||'.';
      t := t||chr(10)||'<br/>Вызвано из '||l_type||' '||l_owner||'.'||l_name||' строка '||l_lineno||'.';
      t := t||chr(10)||'<br/>Параметры:<br/>'||chr(10)||nvl(m_params, xmltype('<empty>не заданы</empty>')).getclobval()||chr(10)||'<br/></body></html>';
--      admin.send_mail_html_v3('dvlp@mggt.ru', emails, 'Ошибка в REF_MAIL.SEND_MAIL', t);
      add_exception('ref_mail.send_mail', null, t);
    end;
/*--------------------------------------------------------------------------------------------------------------------*/
  begin
    prepare_mail(m_name, m_date, m_params, sender, rcp, m_subj, m_body, att, err);
DBMS_OUTPUT.PUT_LINE('TEST5');
    if err is null then
DBMS_OUTPUT.PUT_LINE('TEST6');
      admin.send_mail_html_v3(sender, rcp, m_subj, m_body, att);
    else
      send_error(err);
    end if;
  end;
